{% extends "base/layout.html" %}
{% block title %}
    #todo Create New Home Form: rooms
{% endblock %}

{% block main %}
<h1>create Rooms</h1>
<ul class="nav nav-tabs">
    {% for navfloor in floor_list | sort(attribute='order') %}
        <li class="nav-item">
            <a
                class="nav-link {% if navfloor.item_id == current_user.active_home.active_floor_id %}active{% endif %}"
                href="/home/rooms/setup/{{ navfloor.item_id }}"
            >
                {{ navfloor.get_item().name }}</a
            >
        </li>
    {% endfor %}
</ul>

<h1>
    now editing: {{ room_list.list_name }} floor {{ room_list.parent.get_item().name }} floor id:  {{ room_list.parent.get_item().id }} order:
    {{ room_list.parent.order }}
</h1>
<form 
    hx-post="/room/default"
    hx-target="#default-room-types-container"
    class="input-group mb-3"
>
    <input
        type="text"
        class="form-control"
        placeholder="New Room Type"
        aria-label="New Room Type"
        aria-describedby="basic-addon2"
        name="custom_type"
        id="custom_type"
        hx-trigger="keyup[key=='Enter']"
    />
    <button class="btn btn-secondary" type="submit" id="button-addon2">
        Add Custom Room Type
    </button>
</form>


        <div
            id="default-room-types-container"
            hx-get="/show_list/{{ defaults_list.id }}"
            hx-trigger="load"
            class="container-fluid bg-dark border border-success border-5 rounded-bottom-5"
        >
        </div>#bug: enable drag and drop room types to create new rooms
        <div
            id="room-list-container"
            hx-get="/show_list/{{ room_list.id }}"
            hx-trigger="load"
            class="container-fluid bg-dark border border-primary border-5 rounded-top-5"
        >
        </div>

<script>
    document.addEventListener("htmx:load", function () {
    const types = document.getElementById("default-room-types-container");

    new Sortable(types, {
        group: {
            name: "shared",
            pull: "clone",
            put: false, // Do not allow items to be put into this list
        },
        animation: 150,
        sort: false,
        cursor: "move",
    });

        const sortmap = document.getElementById("room-list-container");
        console.log('sortmap: ' + sortmap);
        new Sortable(sortmap, { 
            group: {
                name: "shared",
                pull: true, // Prevent pulling from this list
            },
            animation: 150,
            ghostClass: "blue-background-class",
            filter: ".htmx-indicator",
            removeOnSpill: true, // Enable plugin
            // Called when item is spilled
            onSpill: function (/**Event*/ evt) {
                evt.item; // The spilled item
                //[ ]: delete item from db on dragout
            },
            onAdd: function (/**Event*/ evt) {
                console.log("onAdd event triggered");
                var itemEl = evt.item; // dragged HTMLElement
                var addedRoomType = itemEl.dataset.name;
                var newIndex = evt.newIndex;
                console.log('addedRoomType: ' + addedRoomType + 'new index: ' + newIndex);

                // Make an htmx AJAX request to the server
                htmx.ajax("POST", "/create/Room/{{ room_list.id }}", {
                    values: { name: addedRoomType, order: newIndex },
                    target: itemEl,
                    swap: "outerHTML", // returns the new content
                });
            },
            onEnd: function () {
                console.log("onEnd event triggered");
                var newOrder = Array.from(sortmap.children).map(
                    (li) => li.dataset.id,
                ); 
                console.log('newOrder: ' + newOrder);
                htmx.ajax("PUT", "/update_list_order/{{ room_list.id }}", {
                    target: "#room-list-container",
                    swap: "innerHTML",
                    values: { order: newOrder },
                });
            },
        });
    });
</script>
        <button                 hx-get="/home/floor/edit/next"
                hx-target="#onboarding-map">Save layout and go to next floor</button>
                [ ] link to start walkthrough

#fixme: design basic room type default block
#fixme: design basic room block

#bug: duplicating list onAdd

<p>----------------------------------------------------------------------------</p>


    <script>
        document.addEventListener("htmx:load", function () {
            const sortlist = document.getElementById("floor-list-container");
            const sortableInstance = new Sortable(sortlist, {
                animation: 150,
                ghostClass: "blue-background-class",
                filter: ".htmx-indicator",
                handle: "#handle",
                removeOnSpill: true, // Enable plugin
            // Called when item is spilled
            onSpill: function (/**Event*/ evt) {
                evt.item; // The spilled item
                console.log("spill");
                console.log("delete evt.item.dataset.id: " + evt.item.dataset.id);
                htmx.ajax("DELETE", "/delete/" + {{floor_list.id}} + "/" + evt.item.dataset.id, {
                    target: "#floor-list-container",
                    swap: "innerHTML",
                    });
                },
                onStart: function () {
                    const tooltipTriggerList = [].slice.call(
                        document.querySelectorAll('[data-bs-toggle="tooltip"]'),
                    );
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        const tooltip =
                            bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                        if (tooltip) {
                            tooltip.dispose();
                        }
                    });
                },

                onEnd: function (evt) {
                    const newIndex = evt.newIndex;
                    const newOrder = Array.from(sortlist.children).map(
                        (li) => li.dataset.id,
                    );
                    console.log("newOrder: " + newOrder);
                    htmx.ajax("PUT", "/update_list_order/{{ floor_list.id }}", {
                        target: "#floor-list-container",
                        swap: "innerHTML",
                        values: { order: newOrder },
                    });
                },
            });
        });
        
    </script>
    //[ ]: delete item from db on dragout
{% endblock %}
