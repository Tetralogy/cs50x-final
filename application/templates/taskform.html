{% extends "layout.html" %}
{% block title %}
    taskform
{% endblock %}

{% block main %}
<div class="container">
    <h1>Welcome, {{ user.username }}!</h1>
</div>

<h1>Task List</h1>

<h2>Submit a new task</h2>

<form action="/new_task" method="post" onsubmit="return newTask(this, 'taskIdPlaceholder')">
    <label for="submit">New blank task:</label>
    <input type="submit" value="Add" class="btn btn-success">
</form>

<form action="/new_task" method="post" onsubmit="return newTask(this, 'taskIdPlaceholder')">
    <label for="task_title">Task Title:</label>
    <input type="text" id="task_title" name="task_title" required><br>
    <label for="task_description">Task Description:</label>
    <textarea id="task_description" name="task_description" required></textarea><br>
    <label for="task_due_time">Task Due Time:</label>
    <input type="datetime-local" id="task_due_time" name="task_due_time" required><br>
    <label for="task_priority">Task Priority:</label>
    <input type="number" id="task_priority" name="task_priority" min="1" max="5" required><br>
    <label for="task_status">Task Status:</label>
    <input type="text" id="task_status" name="task_status" required><br>
    <label for="task_tags">Task Tags:</label>
    <input type="text" id="task_tags" name="task_tags"><br>
    <label for="task_scheduled_time">Task Scheduled Time:</label>
    <input type="datetime-local" id="task_scheduled_time" name="task_scheduled_time"><br>
    <input type="submit" value="Submit">
</form>
<table class="table table-striped table-dark">
    <tr>
        <th>Task ID</th>
        <th>Task Title</th>
        <th>Task Description</th>
        <th>Task Created At</th>
        <th>Task Due Time</th>
        <th>Task Priority</th>
        <th>Task Status</th>
        <th>Task Tags</th>
        <th>Task Scheduled Time</th>
        <th>Task Type</th>
        <th>Completed At</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    {% for task in user.tasks %}
    <tr id="task-{{ task.task_id }}"><p>TEST</p>
        <td>{{ task.task_id }}</td>
        <td>{{ task.task_title }}</td>
        <td>{{ task.task_description }}</td>
        <td>{{ task.task_created_at }}</td>
        <td>{{ task.task_due_time }}</td>
        <td>{{ task.task_priority }}</td>
        <td>{{ task.task_status }}</td>
        <td>{{ task.task_tags }}</td>
        <td>{{ task.task_scheduled_time }}</td>
        <td>{{ task.task_type }}</td>
        <td>{{ task.completed_at }}</td>
        <td><form onsubmit="return editTask(this, '{{ task.task_id }}')">
                <button type="submit" class="btn btn-primary">Edit Task</button>
            </form></td>
        <td><form onsubmit="return deleteTask(this, '{{ task.task_id }}')">
            <button type="submit" class="btn btn-danger">Delete Task</button>
            </form></td>       
    </tr>
    {% endfor %}
</table>

<script>

function newTask(form, taskId) {
    // Collect form data
    const formData = new FormData(form);
    
    fetch(`/new_task`, {
        method: 'post',
        body: formData
    }).then(response => {
        if (response.ok) {
            // add the task element to the DOM
            response.json().then(task => {
                const table = document.getElementsByTagName('table')[0];
                const row = document.createElement('tr');
                row.id = `task-${task.task_id}`;
                row.innerHTML = `
                    <td>${task.task_id}</td>
                    <td>${task.task_title}</td>
                    <td>${task.task_description}</td>
                    <td>${task.task_created_at}</td>
                    <td>${task.task_due_time}</td>
                    <td>${task.task_priority}</td>
                    <td>${task.task_status}</td>
                    <td>${task.task_tags}</td>
                    <td>${task.task_scheduled_time}</td>
                    <td>${task.task_type}</td>
                    <td>${task.completed_at}</td>
                    <td><a href="/edit_task/${task.task_id}"><button type="button" class="btn btn-primary">Edit</button></a></td>
                    <td><form onsubmit="return deleteTask(this, '${task.task_id}')">
                        <button type="submit" class="btn btn-danger">Delete Task</button>
                    </form></td>       
                `;
                table.appendChild(row);
            });
        } else {
            alert('Failed to create task');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the task');
    });
    return false; // Prevent form from submitting normally
}

function editTask(form, taskId) {
    // Collect form data
    const formData = new FormData(form);
    
    fetch(`/edit_task/${taskId}`, {
        method: 'post',
        body: formData
    }).then(response => {
        if (response.ok) {
            // add the task element to the DOM
            response.json().then(task => {
                const table = document.getElementsByTagName('table')[0];
                const row = document.createElement('tr');
                row.id = `task-${task.task_id}`;
                row.innerHTML = `
                    <td>${task.task_id}</td>
                    <td>${task.task_title}</td>
                    <td>${task.task_description}</td>
                    <td>${task.task_created_at}</td>
                    <td>${task.task_due_time}</td>
                    <td>${task.task_priority}</td>
                    <td>${task.task_status}</td>
                    <td>${task.task_tags}</td>
                    <td>${task.task_scheduled_time}</td>
                    <td>${task.task_type}</td>
                    <td>${task.completed_at}</td>
                    <td><a href="/edit_task/${task.task_id}"><button type="button" class="btn btn-primary">Edit</button></a></td>
                    <td><form onsubmit="return deleteTask(this, '${task.task_id}')">
                        <button type="submit" class="btn btn-danger">Delete Task</button>
                    </form></td>       
                `;
                table.appendChild(row);
            });
        } else {
            alert('Failed to create task');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the task');
    });
    return false; // Prevent form from submitting normally
}
    function deleteTask(form, taskId) {
        fetch(`/delete_task/${taskId}`, {
            method: 'DELETE',
        }).then(response => {
            if (response.ok) {
                // Remove the task element from the DOM
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    taskElement.remove();
                } else {
                    console.error('Task element not found in the DOM');
                }
            } else {
                alert('Failed to delete task');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the task');
        });
        return false; // Prevent form from submitting normally
    }
    </script>
{% endblock %}
